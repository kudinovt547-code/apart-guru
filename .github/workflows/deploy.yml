 name: Auto Deploy to Timeweb

  on:
    push:
      branches:
        - main

  jobs:
    deploy:
      name: Deploy to Production
      runs-on: ubuntu-latest

      steps:
        - name: Deploy via SSH
          uses: appleboy/ssh-action@v1.0.3
          env:
            N8N_SECRET: ${{ secrets.N8N_SECRET }}
          with:
            host: ${{ secrets.SERVER_HOST }}
            username: ${{ secrets.SERVER_USER }}
            key: ${{ secrets.SERVER_SSH_KEY }}
            port: 22
            envs: N8N_SECRET
            script: |
              cd /root/apart-guru
              git pull origin main

              touch .env
              if grep -q "NEXT_PUBLIC_N8N_SECRET" .env; then
                sed -i
  "s|^NEXT_PUBLIC_N8N_SECRET=.*|NEXT_PUBLIC_N8N_SECRET=$N8N_SECRET|" .env
              else
                echo "NEXT_PUBLIC_N8N_SECRET=$N8N_SECRET" >> .env
              fi

              docker-compose up -d --build
              docker-compose ps
              echo "âœ… Deployed at $(date)"
